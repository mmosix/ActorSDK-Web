{"version":3,"sources":["../../src/stores/MessageStore.js"],"names":[],"mappings":"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","file":"MessageStore.js","sourcesContent":["/*\n * Copyright (C) 2015-2016 Actor LLC. <https://actor.im>\n */\n\nimport Immutable from 'immutable';\nimport { ReduceStore } from 'flux/utils';\nimport Dispatcher from '../dispatcher/ActorAppDispatcher';\nimport { ActionTypes, MessageChangeReason } from '../constants/ActorAppConstants';\nimport { getFirstUnreadMessageIndex } from '../utils/MessageUtils';\nimport UserStore from './UserStore';\n\nconst MESSAGE_COUNT_STEP = 20;\n\nconst getMessageId = (message) => message ? message.rid : null;\n\nclass MessageStore extends ReduceStore {\n  getInitialState() {\n    return {\n      messages: [],\n      overlay: [],\n      isLoaded: false,\n      receiveDate: 0,\n      readDate: 0,\n      readByMeDate: 0,\n      count: 0,\n      firstMessageId: null,\n      lastMessageId: null,\n      firstUnreadId: null,\n      changeReason: MessageChangeReason.UNKNOWN,\n      selected: new Immutable.Set()\n    };\n  }\n\n  isAllRendered() {\n    const { messages, count } = this.getState();\n    return messages.length === count;\n  }\n\n  reduce (state, action) {\n    switch (action.type) {\n      case ActionTypes.BIND_DIALOG_PEER:\n        return this.getInitialState();\n\n      case ActionTypes.MESSAGES_CHANGED:\n        const firstMessageId = getMessageId(action.messages[0]);\n        const lastMessageId = getMessageId(action.messages[action.messages.length - 1]);\n\n        const nextState = {\n          ...state,\n          firstMessageId,\n          lastMessageId,\n          messages: action.messages,\n          overlay: action.overlay,\n          receiveDate: action.receiveDate,\n          readDate: action.readDate,\n          readByMeDate: action.readByMeDate,\n          isLoaded: action.isLoaded\n        };\n\n        if (firstMessageId !== state.firstMessageId) {\n          nextState.count = Math.min(action.messages.length, state.count + MESSAGE_COUNT_STEP);\n          nextState.changeReason = MessageChangeReason.UNSHIFT;\n        } else if (lastMessageId !== state.lastMessageId) {\n          // TODO: possible incorrect\n          const lengthDiff = action.messages.length - state.messages.length;\n\n          nextState.count = Math.min(action.messages.length, state.count + lengthDiff);\n          nextState.changeReason = MessageChangeReason.PUSH;\n        } else {\n          nextState.count = Math.min(action.messages.length, state.count);\n          nextState.changeReason = MessageChangeReason.UPDATE;\n        }\n\n        if (state.readByMeDate === 0 && action.readByMeDate > 0) {\n          const unreadIndex = getFirstUnreadMessageIndex(action.messages, action.readByMeDate, UserStore.getMyId());\n          if (unreadIndex === -1) {\n            nextState.firstUnreadId = null;\n          } else {\n            nextState.firstUnreadId = action.messages[unreadIndex].rid;\n            if (unreadIndex > nextState.count) {\n              nextState.count = Math.min((action.messages.length - unreadIndex) + MESSAGE_COUNT_STEP, action.messages.length);\n            }\n          }\n        }\n\n        return nextState;\n\n      case ActionTypes.MESSAGES_LOAD_MORE:\n        return {\n          ...state,\n          count: Math.min(state.messages.length, state.count + MESSAGE_COUNT_STEP),\n          changeReason: MessageChangeReason.UNSHIFT\n        };\n\n      case ActionTypes.MESSAGES_TOGGLE_SELECTED:\n        return {\n          ...state,\n          selected: state.selected.has(action.id) ? state.selected.remove(action.id) : state.selected.add(action.id)\n        };\n\n      default:\n        return state;\n    }\n  }\n}\n\nexport default new MessageStore(Dispatcher);\n"]}